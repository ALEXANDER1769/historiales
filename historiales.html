<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historiales de Animales - PYSIGA</title>
<style>
:root {
--verde: #2f6f4e;
--verde-claro: #e6f1eb;
--azul: #2c4f7c;
--tierra: #8b6f47;
--rojo: #e74c3c;
--gris: #7f8c8d;
--morado: #9b59b6;
--fondo: #f7f9f8;
--blanco: #ffffff;
}
body {
margin: 0;
font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
background: var(--fondo);
color: #333;
}
.container {
max-width: 1100px;
margin: auto;
padding: 15px;
}
.card {
background: var(--blanco);
border-radius: 10px;
padding: 15px;
box-shadow: 0 2px 6px rgba(0,0,0,0.08);
margin-bottom: 15px;
}
.header-titulo {
color: var(--azul);
font-size: 24px;
margin: 0 0 15px 0; /* Espacio inferior */
}
.form-busqueda {
display: flex;
flex-wrap: wrap;
gap: 10px;
margin-bottom: 15px;
align-items: end; /* Alinear elementos al final del flex container */
}
.form-busqueda input {
padding: 8px 12px;
font-size: 14px;
border: 1px solid #ccc;
border-radius: 4px;
flex: 1;
min-width: 200px;
}
.form-busqueda button {
padding: 8px 16px;
font-size: 14px;
border: none;
border-radius: 4px;
cursor: pointer;
}
.btn-buscar {
background: var(--azul);
color: white;
}
.btn-cerrar-form {
background: var(--rojo);
color: white;
}
.btn-cerrar-form:hover {
background: #c0392b;
}
.btn-buscar:hover {
background: #1a3c5a;
}
.grafico-container {
width: 100%;
height: 400px;
margin-top: 20px;
}
.tabla-historial {
width: 100%;
border-collapse: collapse;
font-size: 13px;
margin-top: 15px;
}
.tabla-historial th {
background: var(--verde);
color: white;
padding: 6px;
position: sticky;
top: 0;
}
.tabla-historial td {
padding: 6px;
border-bottom: 1px solid #ddd;
text-align: left;
}
/* === LOADER === */
#loader {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
height: 100vh;
background: white;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
z-index: 9999;
}
.vaca-loader {
font-size: 60px;
margin-bottom: 16px;
animation: mover 1s infinite alternate;
}
@keyframes mover {
from { transform: translateX(-5px); }
to { transform: translateX(5px); }
}
</style>
</head>
<body>
<div id="loader">
<div class="vaca-loader">üêÑ</div>
<div id="loader-text">Cargando historiales‚Ä¶</div>
</div>

<div id="contenido" style="display: none;">
<div class="container">
<h1 class="header-titulo">Historiales de Animales</h1>

<div class="card">
<h3>Buscar Historial</h3>
<form id="formBusqueda" class="form-busqueda">
<input type="text" id="inputIdAnimal" placeholder="Ingrese ID o N√∫mero Pr√°ctico del animal" required>
<button type="button" class="btn-cerrar-form" onclick="cerrarVentana()">Cerrar</button> <!-- Bot√≥n de cierre -->
<button type="submit" class="btn-buscar">Buscar Historial</button>
</form>
</div>

<!-- Contenedores para cada tipo de historial -->
<div id="historialLeche" class="card" style="display: none;">
<h3>Historial de Producci√≥n de Leche</h3>
<div id="graficoLeche" class="grafico-container"></div>
<table id="tablaLeche" class="tabla-historial">
<thead><tr><th>Fecha</th><th>Producci√≥n (L)</th><th>Av√≠o</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div id="historialPeso" class="card" style="display: none;">
<h3>Historial de Peso Corporal</h3>
<div id="graficoPeso" class="grafico-container"></div>
<table id="tablaPeso" class="tabla-historial">
<thead><tr><th>Fecha</th><th>Peso (Kg)</th></tr></thead>
<tbody></tbody>
</table>
</div>

<div id="historialSanitario" class="card" style="display: none;">
<h3>Historial Sanitario</h3>
<table id="tablaSanitario" class="tabla-historial">
<thead><tr><th>Fecha</th><th>Tratamiento</th><th>Observaciones</th></tr></thead>
<tbody></tbody>
</table>
</div>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const WORKER_URL = "https://pysiga.d-alexjose.workers.dev"; // Aseg√∫rate que sea tu URL correcta
const urlParams = new URLSearchParams(window.location.search);
const email = urlParams.get('email');

if (!email) {
alert("Par√°metro 'email' no encontrado en la URL.");
location.href = "/"; // O redirige a donde corresponda
}

// Funci√≥n para cerrar la ventana actual
function cerrarVentana() {
window.close();
// Si window.close() no funciona por restricciones del navegador, puedes intentar redirigir a una p√°gina vac√≠a o al panel principal si lo tienes como referer.
// history.back(); // Esto vuelve a la p√°gina anterior, puede no ser deseable si fue abierta con window.open
// location.href = 'https://tu-panel-principal.com'; // Reemplaza con tu URL real
}

document.getElementById("formBusqueda").addEventListener("submit", async (e) => {
e.preventDefault();
const idAnimal = document.getElementById("inputIdAnimal").value.trim();
if (!idAnimal) {
alert("Por favor ingrese un ID o N√∫mero Pr√°ctico.");
return;
}
await buscarHistorial(idAnimal);
});

async function buscarHistorial(idAnimal) {
try {
document.getElementById("loader-text").textContent = "Buscando historial...";
document.getElementById("loader").style.display = "flex";

const res = await fetch(WORKER_URL, {
method: "POST",
headers: { "Content-Type": "application/json" },
body: JSON.stringify({
accion: "obtenerHistorialAnimal",
email: email,
idAnimal: idAnimal // Enviar el ID/N√∫mero Pr√°ctico tal cual
})
});
const data = await res.json();

document.getElementById("loader").style.display = "none";

if (!data.ok) {
throw new Error(data.error || "Error desconocido");
}

// Mostrar resultados
mostrarHistorial(data.historial);

} catch (e) {
document.getElementById("loader").style.display = "none";
console.error("Error:", e);
alert(`Error al obtener historial: ${e.message}`);
}
}

function mostrarHistorial(historial) {
// Resetear contenedores
document.getElementById("historialLeche").style.display = "none";
document.getElementById("historialPeso").style.display = "none";
document.getElementById("historialSanitario").style.display = "none";

// Mostrar y actualizar historial de Leche
if (historial.leche && historial.leche.length > 0) {
document.getElementById("historialLeche").style.display = "block";
renderizarTabla("tablaLeche", historial.leche);
graficarDatos("graficoLeche", historial.leche, "Producci√≥n (L)", "line", "Fecha");
} else {
document.getElementById("tablaLeche").querySelector("tbody").innerHTML = '<tr><td colspan="3">No se encontraron registros de producci√≥n de leche.</td></tr>';
}

// Mostrar y actualizar historial de Peso
if (historial.peso && historial.peso.length > 0) {
document.getElementById("historialPeso").style.display = "block";
renderizarTabla("tablaPeso", historial.peso);
graficarDatos("graficoPeso", historial.peso, "Peso (Kg)", "line", "Fecha");
} else {
document.getElementById("tablaPeso").querySelector("tbody").innerHTML = '<tr><td colspan="2">No se encontraron registros de peso.</td></tr>';
}

// Mostrar y actualizar historial Sanitario
if (historial.sanitario && historial.sanitario.length > 0) {
document.getElementById("historialSanitario").style.display = "block";
renderizarTabla("tablaSanitario", historial.sanitario);
} else {
document.getElementById("tablaSanitario").querySelector("tbody").innerHTML = '<tr><td colspan="3">No se encontraron registros sanitarios.</td></tr>';
}

document.getElementById("contenido").style.display = "block";
}

function renderizarTabla(id, datos) {
const tbody = document.getElementById(id).querySelector("tbody");
tbody.innerHTML = "";
if (datos && datos.length > 0) {
datos.forEach(row => {
const tr = document.createElement("tr");
// Ajustar seg√∫n los campos de cada historial
if (row.produccion !== undefined) { // Leche
tr.innerHTML = `<td>${row.fecha}</td><td>${row.produccion}</td><td>${row.avio}</td>`;
} else if (row.peso !== undefined) { // Peso
tr.innerHTML = `<td>${row.fecha}</td><td>${row.peso}</td>`;
} else if (row.tratamiento !== undefined) { // Sanitario
tr.innerHTML = `<td>${row.fecha}</td><td>${row.tratamiento}</td><td>${row.observaciones}</td>`;
}
tbody.appendChild(tr);
});
} else {
// Este caso se cubre en mostrarHistorial, pero por si acaso
tbody.innerHTML = '<tr><td colspan="3">Sin registros</td></tr>';
}
}

function graficarDatos(containerId, datos, labelY, tipo, labelX = "Fecha") {
const ctx = document.getElementById(containerId).getContext('2d');
// Destruir instancia anterior si existe
if (window.myCharts && window.myCharts[containerId]) {
window.myCharts[containerId].destroy();
}
if (!window.myCharts) window.myCharts = {};
const data = {
labels: datos.map(d => d.fecha),
datasets: [{
label: labelY,
data: datos.map(d => d[labelY.toLowerCase().replace(/\s/g, '')]), // Asigna valor din√°micamente, ej: 'produccion' o 'peso'
borderColor: 'rgb(75, 192, 192)',
backgroundColor: 'rgba(75, 192, 192, 0.2)',
fill: false,
}]
};
const config = {
type: tipo, // 'line', 'bar', etc
data: data,
options: {
responsive: true,
plugins: {
legend: {
position: 'top',
},
tooltip: {
mode: 'index',
intersect: false
}
},
scales: {
x: {
display: true,
title: {
display: true,
text: labelX
}
},
y: {
display: true,
title: {
display: true,
text: labelY
}
}
}
}
};
window.myCharts[containerId] = new Chart(ctx, config);
}

// Ocultar loader inicial y mostrar contenido si ya hay email
document.addEventListener("DOMContentLoaded", () => {
if (email) {
document.getElementById("loader").style.display = "none";
document.getElementById("contenido").style.display = "block";
}
});

</script>
</body>
</html>
